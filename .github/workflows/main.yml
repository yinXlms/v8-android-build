name: Build V8 Android

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git \
            python3 \
            python3-pip \
            clang \
            lsb-release

      - name: Clone depot_tools
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "$PWD/depot_tools" >> $GITHUB_PATH

      - name: Fetch V8 source
        run: |
          mkdir v8
          cd v8
          fetch v8
          cd v8
          gclient sync

      - name: Install Android NDK
        run: |
          sudo apt install -y unzip
          wget https://dl.google.com/android/repository/android-ndk-r26d-linux.zip
          unzip -q android-ndk-r26d-linux.zip
          echo "ANDROID_NDK_HOME=$PWD/android-ndk-r26d" >> $GITHUB_ENV

      - name: GN gen (android arm64)
        run: |
          cd v8/v8
          gn gen out/android_arm64.release --args='
            is_debug=false
            target_os="android"
            target_cpu="arm64"
            v8_monolithic=true
            v8_use_external_startup_data=false
            v8_enable_i18n_support=false
            use_custom_libcxx=false
          '

      - name: Build V8
        run: |
          cd v8/v8
          ninja -C out/android_arm64.release v8_monolith

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: v8-android-arm64
          path: v8/v8/out/android_arm64.release/obj/libv8_monolith.a
